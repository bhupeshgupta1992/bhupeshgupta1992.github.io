<!DOCTYPE html>
<html>
<head>
<title>Submit Manuscript | IJMCH</title>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">
  <div class="card p-4">
    <h3>Submit Manuscript</h3>

    <input type="text" id="title" class="form-control mb-2" placeholder="Manuscript Title">
    <textarea id="abstract" class="form-control mb-2" placeholder="Abstract"></textarea>
    <input type="file" id="file" class="form-control mb-3">

    <button id="submitBtn">Submit</button>
  </div>
</div>

<script type="module">
  alert("Submit JS Loaded");
import { auth, db, storage } from "./firebase-config.js";
import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  currentUser = user;
});

const submitBtn = document.getElementById("submitBtn");

submitBtn.addEventListener("click", async () => {

  if (!currentUser) {
    alert("Please login first");
    return;
  }

  const title = document.getElementById("title").value;
  const abstract = document.getElementById("abstract").value;
  const file = document.getElementById("file").files[0];

  if (!title || !abstract || !file) {
    alert("Please fill all fields and upload file");
    return;
  }

  try {
    const storageRef = ref(storage, "manuscripts/" + Date.now() + "_" + file.name);
    await uploadBytes(storageRef, file);
    const fileURL = await getDownloadURL(storageRef);

    await addDoc(collection(db, "submissions"), {
      title: title,
      abstract: abstract,
      authorEmail: currentUser.email,
      fileURL: fileURL,
      status: "Submitted",
      createdAt: new Date()
    });

    alert("Manuscript submitted successfully!");
    window.location.href = "dashboard.html";

  } catch (error) {
    alert(error.message);
  }
});
</script>

</body>
</html>
